---
title: "Analises Modelos Mistos"
author: "LucianoRogerio e HenriqueBernardino"
date: "2021-10-12"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

[Wrong Page?](index.html)

## Introduction

```{r}
library(here)
suppressMessages(library(tidyverse))
suppressMessages(library(plyr))
library(reactable)
suppressMessages(library(data.table))
suppressMessages(source(here::here("code", "MixedModelsFunctions.R")))

PhenoData <- readRDS(here::here("output", "DadosFenotipicosv2.RDS"))


PhenoData$block_number <- as.character(PhenoData$block_number)
PhenoData2 <- PhenoData %>% filter(!is.na(Y))
traits <- unique(PhenoData2$traits)

fmfit <- PhenoData2 %>% dlply(.variables = c("traits"),
                              .fun = analyzeTrial.lme4)
ResFixEffect <- lapply(fmfit, FUN = as.data.frame(anova))
ResAnInt <- matrix(unlist(ResFixEffect,use.names = T),
                   nrow = 2, byrow = F)
ResAnFin <- rbind(ResAnInt[,1:4],
                  ResAnInt[,5:8],
                  ResAnInt[,9:12],
                  ResAnInt[,13:16])
colnames(ResAnFin) <- c("DF", "SumSq", "MeanSq", "Fvalue")
ResAnovaFinal <- data.frame(Trait = rep(traits, 2),
                            Factor = rep(c("Control", "Block"),
                                         times = 4),
                            ResAnFin)

# Table 1. Anova of the fixed effects of Cassava foliar diseases
ResAnovaFinal %>% reactable(columns = list(
  SumSq = colDef(format = colFormat(digits = 3, locales = "en-US")),
  MeanSq = colDef(format = colFormat(digits = 3, locales = "en-US")),
  Fvalue = colDef(format = colFormat(digits = 3, locales = "en-US"))))


rdfmfit <- PhenoData2 %>% dlply(.variables = c("traits"),
                                .fun = analyzeTrialrdMod.lme4)


Deviances <- NULL
for(i in traits){
Deviances[[i]] <- data.frame(Deviance.MM(fmfit[[i]], rdfmfit[[i]]))[2,6:8]
rownames(Deviances[[i]]) <- i
  
}

ResDeviances <- data.frame(t(sapply(Deviances, FUN = rbind)))

# Table 2. Deviance Analysis for cassava foliar disease
ResDeviances %>% reactable()

H2 <- sapply(fmfit, FUN = getVarComp.lme4) %>% t() %>% as.data.frame()
colnames(H2) <- c("VarClone", "VarRes")
H2 <- H2 %>% mutate(VarClone = as.numeric(VarClone),
               VarRes = as.numeric(VarRes),
               VarFen = VarClone + VarRes,
               H2 = VarClone/VarFen)
# Table 3. Heritabilities of cassava foliar disease
H2 %>% reactable(columns = list(
  VarClone = colDef(format = colFormat(digits = 4, locales = "en-US")),
  VarRes = colDef(format = colFormat(digits = 4, locales = "en-US")),
  VarFen = colDef(format = colFormat(digits = 4, locales = "en-US")),
  H2 = colDef(format = colFormat(digits = 4, locales = "en-US"))))


### Obter estimativas de m√©dias + Blups dos clones

MediasFix <- as.matrix(sapply(fmfit, FUN = (fixef)))
MediasFix[2:32, ] <- MediasFix[2:32,] +
  matrix(rep(MediasFix[1, 1:4], each = 31), nrow = 31, ncol = 4,
         byrow = F)
MediasFix <- as.data.frame(MediasFix)
rownames(MediasFix)[1] <- "controlClones"
MediasFix$CLONE <- rownames(MediasFix)

MediasFix %<>% filter(CLONE %like% "control") %>%
  as.data.frame() %>% dplyr::select(CLONE, everything())
rownames(MediasFix) <- NULL
MediasFix$CLONE <- gsub(pattern = "control", replacement = "", x = MediasFix$CLONE)
MediasFix %>% filter(CLONE != "Clones") -> MediasFix

#### Obter os efeitos aleatorio dos Clones

BLUPsAle <- lapply(fmfit, FUN = getBLUPs.lme4)

BLUPSDisea <- data.frame(CLONE = rownames(BLUPsAle[1]$Anth))

for(i in names(BLUPsAle)){
  drg<-data.frame(CLONE = rownames(BLUPsAle[[i]]), stringsAsFactors=F)
  drg[,i] <-BLUPsAle[[i]]
  BLUPSDisea<-merge(BLUPSDisea,drg,by="CLONE",all.x=T)
}

BLUPSDisea <- BLUPSDisea %>% filter(CLONE %like% ":1")
BLUPSDisea$CLONE <- gsub(pattern = ":1", replacement = "", BLUPSDisea$CLONE)

BLUPS <- rbind(BLUPSDisea, MediasFix)

saveRDS(BLUPS, here::here("output", "BLUPsDisease.RDS"))

# Table 3. Blups of the accessions for cassava foliar diseases
BLUPS %>% reactable(defaultPageSize = 25, columns = list(
  Anth = colDef(format = colFormat(digits = 4, locales = "en-US")),
  BlLS = colDef(format = colFormat(digits = 4, locales = "en-US")),
  BrLS = colDef(format = colFormat(digits = 4, locales = "en-US")),
  WhLS = colDef(format = colFormat(digits = 4, locales = "en-US"))))
```

[Last page](AnalisesDescritivas.html)
[Back to home](index.html)
