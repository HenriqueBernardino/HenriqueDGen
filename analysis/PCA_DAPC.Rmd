---
title: "Analise de Componentes Principais e Discriminantes"
author: "LucianoRogerio e HenriqueBernardino"
date: "2021-11-02"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Introduction

[Wrong Page?](index.html)


```{r}
suppressMessages(library(tidyverse))
suppressMessages(library(adegenet))
library(here)

BLUPS <- readRDS(here::here("output", "BLUPsDisease.RDS"))

### Analise de Componentes Principais

BLUPS[ , 2:6] <- scale(BLUPS[ , 2:6], center = T, scale = T)
BLUPS[is.na(BLUPS)] <- 0
PCA <- prcomp(BLUPS[,-1])

Perc <- 100*PCA$sdev^2/sum(PCA$sdev^2)
Perc

PercAc <- as.vector(rep(NA, times = length(Perc)))
for(i in 1:length(Perc)) {
  PercAc[i] <- sum(Perc[1:i])
  names(PercAc)[i] <- i
}

# Fig 1. Grafico de Barras das variancias acumuladas dos componentes principais para tolerancia as doencas foliares.
barplot(PercAc, main = "Variance explained by PCA",
        ylab = "Cumulative variance (%)", xlab = "Number of retained PCs",
        col = c("gray", "red", "gray", "gray", "gray"))

##

PointPCA1 <- as.data.frame(PCA$x)
ArrowPCA1 <- as.data.frame(PCA$rotation)
LabelsPCA1 <- 3*ArrowPCA1
LabelsPCA1$PC2[1] <- 3
LabelsPCA1[2, 1:2] <- c(1.1, -1.1)
LabelsPCA1[3, 1:2] <- c(2.5, 0.45)
LabelsPCA1[4, 1:2] <- c(2.5, 0.15)
LabelsPCA1[5, 1:2] <- c(0.8, 0.6)

ggplot(data = PointPCA1, aes(x = PC1, y = PC2)) +
  geom_point(na.rm = T, colour = "gray") + geom_rug(col = "steelblue", alpha = 0.2, size = 1.5) +
  geom_segment(mapping = aes(x = 0, xend = 3*PC1, y = 0, yend = 3*PC2),
               colour = "red",
               data = ArrowPCA1, arrow = arrow(type = "closed",
                                               length = unit(0.2,units = "cm"))) +
  geom_text(mapping = aes(x = PC1, y = PC2, label = rownames(ArrowPCA1)),
            data = LabelsPCA1, colour = "black") + 
  theme_bw() +
  xlab("PC1 - 47.28%") + ylab("PC2 - 21.01%")

### AnÃ¡lise Discriminante de Componentes Principais

library(adegenet); library(ggplot2)

BLUPS <- readRDS(here::here("output", "BLUPsDisease.RDS"))
BLUPS[ , 2:6] <- scale(BLUPS[ , 2:6], center = T, scale = T)
BLUPS[is.na(BLUPS)] <- 0
rownames(BLUPS) <- BLUPS$CLONE
BLUPS$CLONE <- NULL

set.seed(1)
DAPCHen <- find.clusters(BLUPS, n.pca = 2, max.n.clust = 20, choose.n.clust = FALSE, criterion = "diffNgroup")
ClassDAPCHen <- DAPCHen$grp


DAPCHenGraph <- dapc(BLUPS, grp = ClassDAPCHen, n.pca = 2, n.da = 2)
saveRDS(DAPCHenGraph, here::here("output", "DAPCAn.RDS"))

DAPCIndPoint <- data.frame(DAPCHenGraph$ind.coord, grp = DAPCHenGraph$grp)
DAPCGrpEllip <- data.frame(DAPCHenGraph$grp.coord, grp = as.character(1:4))
ArrowDAPC <- as.data.frame(DAPCHenGraph$var.contr)
LabelsDAPC <- data.frame(Trait = rownames(ArrowDAPC), ArrowDAPC*5)
LabelsDAPC[1,3]   <- 4.7
LabelsDAPC[2,2:3] <- c(0.7, 0.8)
LabelsDAPC[3,2:3] <- c(2.5, 0.45)
LabelsDAPC[4,2:3] <- c(2.5, -0.35)
LabelsDAPC[5,2:3] <- c(0.3, -0.35)

ggplot(data = DAPCIndPoint, aes(x = LD1, y = LD2, color = grp)) +
  geom_point(na.rm = T) + geom_rug(col = "steelblue", alpha = 0.2, size = 1.5) +
  theme_bw() +
  scale_color_viridis_d() +
  stat_ellipse(geom="polygon", aes(fill = grp), 
               alpha = 0.2, 
               show.legend = FALSE, 
               level = 0.95) + guides(color = "none") + 
  geom_label(data = DAPCGrpEllip, mapping = aes(x = LD1, y = LD2, label = grp)) +
  geom_segment(mapping = aes(x = 0, xend = 5*LD1, y = 0, yend = 5*LD2),
               colour = "red",
               data = ArrowDAPC, arrow = arrow(type = "closed",
                                               length = unit(0.2,units = "cm"))) +
    geom_text(mapping = aes(x = LD1, y = LD2, label = Trait),
            data = LabelsDAPC, colour = "black") +
  xlab("LD1 - 56.54%") + ylab("LD2 - 11.75%")

library(reshape2)
BLUPS$CLONE <- rownames(BLUPS)
BLUPS$Grp <- DAPCHenGraph$grp

BLUPSBoxplot <- melt(BLUPS, variable.name = "Trait", value.name = "Y", id.vars = c("CLONE", "Grp"))

ggplot(data = BLUPSBoxplot, mapping = aes(x = Grp, y = Y, fill = Grp)) + ylim(-3,4) +
  geom_boxplot(outlier.shape = NA) + facet_wrap(facets = ~ Trait, ncol = 3) +
  scale_fill_viridis_d() + guides(fill = "none") + ylab("BLUPs") + xlab("DACP Group")

```

[Next page](Den_IndSH.html)
[Last page]()
[Back to home](index.html)
